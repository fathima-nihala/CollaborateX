// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enum for user roles
enum UserRole {
  ADMIN
  MANAGER
  USER
}

// Enum for task status
enum TaskStatus {
  OPEN
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  ARCHIVED
}

// Enum for task priority
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// User model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  firstName String?
  lastName  String?
  role      UserRole @default(USER)
  
  // Relations
  projects         ProjectMember[]
  taskAssignments  Task[]          @relation("assignedTasks")
  taskCreations    Task[]          @relation("createdTasks")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
}

// Project model
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("active")
  
  // Relations
  members     ProjectMember[]
  tasks       Task[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

// Project membership (join table for many-to-many)
model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      UserRole @default(USER)  // Role within project (can be different from global role)
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// Task model
model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(OPEN)
  priority    TaskPriority @default(MEDIUM)
  
  // Foreign keys
  projectId  String
  createdById String
  assignedToId String?
  
  // Relations
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy  User    @relation("createdTasks", fields: [createdById], references: [id], onDelete: Restrict)
  assignedTo User?   @relation("assignedTasks", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  // Task tracking
  dueDate DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
}

// Refresh token storage (for token invalidation / logout)
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([expiresAt])
}
